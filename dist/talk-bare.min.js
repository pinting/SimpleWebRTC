var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},Talk;!function(a){var b=function(b){function c(a,c){"undefined"==typeof c&&(c="http://localhost:8000");var d=this;b.call(this),this.handler=a,this.handler.on("message",this.send.bind(this)),this.server=io.connect(c),this.server.on("connect",function(){d.id=d.server.socket.sessionid,d.emit("connectionReady",d.id)}),this.server.on("message",this.get.bind(this))}return __extends(c,b),c.prototype.send=function(b){a.log("Sending:",b),this.server.emit("message",b)},c.prototype.get=function(b){if(a.log("Getting:",b),b.key&&b.value&&b.peer&&b.handler){var c=this.findHandler(b.handler).get(b.peer);c?(a.log("Peer found!"),c.parseMessage(b.key,b.value)):a.warn("Peer not found!")}},c.prototype.findHandler=function(a){var b=this.handler;return a.forEach(function(a){b=b.h(a)}),b},c}(WildEmitter);a.Connection=b}(Talk||(Talk={}));var Talk;!function(a){var b=function(b){function c(c,d){b.call(this),this.config={media:{mandatory:{OfferToReceiveAudio:!1,OfferToReceiveVideo:!1}}},this.handlers=[],this.peers=[],d||a.isStr(c)||(d=c,c=null),a.extend(this.config,d),this.id=c}return __extends(c,b),c.prototype.createHandler=function(b,d){var e=this;"undefined"==typeof d&&(d=c);var f=new d(b,this.config);return f.on("*",function(){for(var b=[],c=0;c<arguments.length-0;c++)b[c]=arguments[c+0];switch(b[0]){case"message":var d=b[1];d=a.clone(d),d.handler=[f.id].concat(d.handler),e.emit("message",d);break;default:e.emit.apply(e,b)}}),a.log("Handler created:",f),this.handlers.push(f),f},c.prototype.h=function(a,b){"undefined"==typeof b&&(b=c);var d=!1;return this.handlers.some(function(b){return b.id===a?(d=b,!0):!1}),d||(d=this.createHandler(a,b)),d},c.prototype.add=function(b,c){var d=this;"undefined"==typeof c&&(c=a.Peer);var e=new c(b,this.config);return e.on("*",function(){for(var a=[],b=0;b<arguments.length-0;b++)a[b]=arguments[b+0];switch(a[0]){case"peerClosed":var c=d.peers.indexOf(e);c>=0&&d.peers.splice(c,1);default:d.emit.apply(d,a)}}),a.log("Peer added:",e),this.peers.push(e),e},c.prototype.get=function(a){var b=!1;return this.peers.some(function(c){return c.id===a?(b=c,!0):!1}),b},c.prototype.find=function(b,c){var d;switch(a.isObj(b)?d=this.peers.filter(function(c){return a.comp(b,c)}):(d=this.peers,c=b),typeof c){case"function":d.forEach(c);break;case"string":d.forEach(function(a){a[c]()})}return d},c}(WildEmitter);a.Handler=b}(Talk||(Talk={}));var Talk;!function(a){function b(b){b.log&&(a.log=b.log.bind(b)),b.warn&&(a.warn=b.warn.bind(a.warn))}function c(b,c,d){return"undefined"==typeof b&&(b=!0),"undefined"==typeof c&&(c=!0),(!a.userMedia||a.userMedia.ended)&&(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia)({audio:b,video:c},function(b){a.log("User media request was successful"),a.userMedia=b,e(d)(b)},function(b){throw a.warn(b),Error(b)}),a.userMedia}function d(a,b){return a.src=window.URL?window.URL.createObjectURL(b):b,a.autoplay=!0,a}function e(a){return"function"==typeof a?a:s}function f(a){return a.replace(/\s/g,"-").replace(/[^A-Za-z0-9_\-]/g,"").toString()}function g(a){return a.replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function h(a){if(null===a||void 0===a)return!0;if(Array.isArray(a)||"string"==typeof a)return 0===a.length;for(var b in a)if(a.hasOwnProperty(b))return!1;return!0}function i(a){return"string"==typeof a&&!h(a)}function j(a){return a===Object(a)}function k(a){return!isNaN(parseFloat(a))&&isFinite(a)}function l(a,b){return"undefined"==typeof a&&(a=0),"undefined"==typeof b&&(b=Math.pow(10,16)),Math.floor(Math.random()*(b-a+1)+a)}function m(a){"undefined"==typeof a&&(a=8);for(var b="";a>0;a--)b+=Math.floor(a/2)===a/2?"bcdfghjklmnpqrstvwxyz"[l(0,20)]:"aeiou"[l(0,4)];return b}function n(a){return CryptoJS.SHA256(a).toString()}function o(a,b){return a.indexOf(b)>=0}function p(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}function q(a){return j(a)?Array.isArray(a)?a.slice(0):p({},a):a}function r(a,b){for(var c in a)if(!(j(a[c])&&j(b[c])&&r(a[c],b[c]))&&a[c]!==b[c])return!1;return!0}function s(){for(var a=[],b=0;b<arguments.length-0;b++)a[b]=arguments[b+0]}a.PeerConnection=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection,a.SessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription,a.IceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate,a.MediaStream=window.MediaStream||window.webkitMediaStream,a.log=s,a.warn=s,a.userMedia,a.supports=function(a){if(!this.PeerConnection)return{};a=a||{iceServers:[{url:"stun:stun.l.google.com:19302"}]};var b,c,d=!!window.webkitRTCPeerConnection,e=!0,f=!1,g=!1,h=!0;try{b=new this.PeerConnection(a,{optional:[{RtpDataChannels:!0}]})}catch(i){h=!1,e=!1}if(h)try{c=b.createDataChannel("_test")}catch(i){h=!1}if(h){try{c.binaryType="blob",f=!0}catch(i){}var j=new this.PeerConnection(a,{});try{var k=j.createDataChannel("_reliableTest",{});g=k.reliable}catch(i){}j.close()}if(e&&(e=!!b.addStream),!d&&h){var l=new this.PeerConnection(a,{optional:[{RtpDataChannels:!0}]});l.onnegotiationneeded=function(){d=!0},l.createDataChannel("_negotiationTest"),setTimeout(function(){l.close()},1e3)}return b&&b.close(),{negotiation:d,media:e,blob:f,sctp:g,data:h}}(),a.logger=b,a.getUserMedia=c,a.attachMediaStream=d,a.safeCb=e,a.safeStr=f,a.safeText=g,a.isEmpty=h,a.isStr=i,a.isObj=j,a.isNum=k,a.randNum=l,a.randWord=m,a.sha256=n,a.find=o,a.extend=p,a.clone=q,a.comp=r,a.noop=s}(Talk||(Talk={}));var Talk;!function(a){var b=function(b){function c(c,d){b.call(this),this.config={options:{iceServers:[{url:"stun:stun.l.google.com:19302"},{url:"stun:stun1.l.google.com:19302"},{url:"stun:stun2.l.google.com:19302"},{url:"stun:stun3.l.google.com:19302"},{url:"stun:stun4.l.google.com:19302"}]},media:{mandatory:{OfferToReceiveAudio:!1,OfferToReceiveVideo:!1}},negotiate:!1},this.channels=[],a.extend(this.config,d),this.id=c,this.pc=new a.PeerConnection(this.config.options,{optional:[{RtpDataChannels:!a.supports.sctp},{DtlsSrtpKeyAgreement:!0}]}),this.pc.oniceconnectionstatechange=this.onConnectionChange.bind(this),this.pc.onicechange=this.onConnectionChange.bind(this),this.pc.onnegotiationneeded=this.negotiate.bind(this),this.pc.onremovestream=this.onRemoveStream.bind(this),this.pc.ondatachannel=this.onDataChannel.bind(this),this.pc.onicecandidate=this.onCandidate.bind(this),this.pc.onaddstream=this.onAddStream.bind(this)}return __extends(c,b),c.prototype.sendMessage=function(a,b){var c={peer:this.id,value:b,handler:[],key:a};this.emit("message",c)},c.prototype.parseMessage=function(b,c){switch(a.log("Parsing:",b,c),b){case"offer":this.answer(c);break;case"answer":this.handleAnswer(c);break;case"candidate":this.handleCandidate(c);break;default:return!1}return!0},c.prototype.addStream=function(b){this.localStream=new a.MediaStream(b),this.pc.addStream(this.localStream,this.config.media),a.log("Stream was added:",this.localStream),a.supports.negotiation||this.negotiate()},c.prototype.onAddStream=function(b){b.stream?(a.log("Remote stream was added:",b.stream),this.remoteStream=b.stream,this.emit("streamAdded",this)):a.warn("Remote stream could not be added:",b)},c.prototype.onRemoveStream=function(b){this.remoteStream={},this.emit("streamRemoved",this),a.log("Remote stream was removed from peer:",b)},c.prototype.send=function(b,c){var d=this.getDataChannel(b);return d&&"open"===d.readyState?(d.send(JSON.stringify(c)),!0):(a.warn("Data channel named `%s` does not exists or it is not opened",b),!1)},c.prototype.getDataChannel=function(a){var b=!1;return this.channels.some(function(c){return c.label===a?(b=c,!0):!1}),b},c.prototype.configDataChannel=function(b){var c=this;b.onclose=function(d){a.log("Channel named `%s` was closed",b.label),c.emit("channelClosed",c,d)},b.onerror=function(b){a.warn("Channel error:",b),c.emit("channelError",c,b)},b.onopen=function(d){a.log("Channel named `%s` was opened",b.label),c.emit("channelOpened",c,d)},b.onmessage=function(d){if(d.data){var e=JSON.parse(d.data);a.log("Getting (%s):",b.label,e),c.emit("channelMessage",c,e)}}},c.prototype.addDataChannel=function(b,c){var d=this.pc.createDataChannel(b,c);return this.configDataChannel(d),this.channels.push(d),a.log("Data channel was added:",d),a.supports.negotiation||this.negotiate(),d},c.prototype.onDataChannel=function(b){b.channel?(this.configDataChannel(b.channel),this.channels.push(b.channel),a.log("Data channel was added:",b.channel)):a.warn("Data channel could not be added",b)},c.prototype.onConnectionChange=function(){switch(a.log("Ice connection state was changed to `%s`",this.pc.iceConnectionState),this.pc.iceConnectionState){case"disconnected":case"failed":this.close();break;case"completed":case"closed":this.pc.onicecandidate=a.noop;break;default:this.pc.onicecandidate=this.onCandidate.bind(this)}},c.prototype.onCandidate=function(b){b.candidate?(a.log("Candidate was found:",b.candidate),this.sendMessage("candidate",b.candidate),this.pc.onicecandidate=a.noop):a.log("End of candidates",b)},c.prototype.handleCandidate=function(b){b.candidate&&b.sdpMid&&a.isNum(b.sdpMLineIndex)?(a.log("Handling received candidate:",b),this.pc.addIceCandidate(new a.IceCandidate(b))):a.warn("Candidate could not be handled:",b)},c.prototype.negotiate=function(){a.log("Negotiation is needed"),this.config.negotiate&&("stable"===this.pc.signalingState?this.offer():a.warn("Signaling state is not stable"))},c.prototype.offer=function(){var b=this;a.log("Creating an offer"),this.pc.createOffer(function(c){b.pc.setLocalDescription(c,function(){b.sendMessage("offer",c),a.log("Offer created:",c)},function(b){a.warn(b)})},function(b){a.warn(b)},this.config.media)},c.prototype.answer=function(b){var c=this;a.log("Answering for an offer:",b),this.pc.setRemoteDescription(new a.SessionDescription(b),function(){c.pc.createAnswer(function(b){c.pc.setLocalDescription(b,function(){c.sendMessage("answer",b)},function(b){a.warn(b)})},function(b){a.warn(b)},c.config.media)},function(b){a.warn(b)})},c.prototype.handleAnswer=function(b){a.log("Handling an answer:",b),this.pc.setRemoteDescription(new a.SessionDescription(b),function(){a.log("Answer was handled successfully")},function(b){a.warn(b)})},c.prototype.close=function(){this.pc.close(),this.emit("peerClosed",this),a.log("Peer closed:",this)},c.prototype.mute=function(){this.remoteStream.getAudioTracks().forEach(function(a){a.enabled=!1}),a.log("Peer audio was muted:",this)},c.prototype.unmute=function(){this.remoteStream.getAudioTracks().forEach(function(a){a.enabled=!0}),a.log("Peer audio was unmuted:",this)},c.prototype.pause=function(){this.remoteStream.getVideoTracks().forEach(function(a){a.enabled=!1}),a.log("Peer video was paused:",this)},c.prototype.resume=function(){this.remoteStream.getVideoTracks().forEach(function(a){a.enabled=!0}),a.log("Peer video was resumed:",this)},c.prototype.muteLocal=function(){this.localStream.getAudioTracks().forEach(function(a){a.enabled=!1}),a.log("Local audio for the peer was muted:",this)},c.prototype.unmuteLocal=function(){this.localStream.getAudioTracks().forEach(function(a){a.enabled=!0}),a.log("Local audio for the peer was unmuted:",this)},c.prototype.pauseLocal=function(){this.localStream.getVideoTracks().forEach(function(a){a.enabled=!1}),a.log("Local video for the peer was paused:",this)},c.prototype.resumeLocal=function(){this.localStream.getVideoTracks().forEach(function(a){a.enabled=!0}),a.log("Local video for the peer was resumed:",this)},c}(WildEmitter);a.Peer=b}(Talk||(Talk={}));var Talk;!function(a){var b=function(b){function c(c,d,e,f){"undefined"==typeof d&&(d="http://localhost:8000"),"undefined"==typeof e&&(e=a.noop),b.call(this,c,d),this.onAnswer=f?f:e,this.onOffer=e,this.server.on("remove",this.remove.bind(this))}return __extends(c,b),c.prototype.get=function(b){if(a.log("Getting:",b),b.key&&b.value&&b.peer){var c=this.handler.get(b.peer);c||"offer"!==b.key||(c=this.handler.add(b.peer),this.onAnswer(c)),c?(a.log("Peer found!"),c.parseMessage(b.key,b.value)):a.warn("Peer not found!")}},c.prototype.join=function(b,c,d){var e=this;this.server.emit("join",b,c,function(f,g){a.log("Joined to room `%s`",b),f&&a.warn(f),g.forEach(function(a){var b=e.handler.add(a.id);e.onOffer(b),b.offer()}),e.room=b,e.type=c,a.safeCb(d)(f,g)})},c.prototype.leave=function(){a.log("Room `%s` was left",this.room),this.server.emit("leave"),this.handler.find("close"),this.room=null,this.type=null},c.prototype.remove=function(b){a.log("Removing a peer:",b);var c=this.handler.get(b);return c?(c.close(),!0):!1},c}(a.Connection);a.Room=b}(Talk||(Talk={}));