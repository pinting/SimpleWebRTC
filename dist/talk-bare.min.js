var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},Talk;!function(a){!function(b){var c=function(b){function c(){b.apply(this,arguments)}return __extends(c,b),c.prototype.send=function(){},c.prototype.get=function(b){if(b.key&&b.value&&b.peer&&b.group){var c=this.findGroup(b.group).get(b.peer);c?c.parseMessage(b.key,b.value):a.warn("Peer not found!")}},c.prototype.connectionReady=function(b){this.id=b,this.emit("ready",b),a.log("Connection is ready:",b)},c.prototype.findGroup=function(a){var b=this.group;return a.forEach(function(a){b=b.h(a)}),b},c}(WildEmitter);b.Pure=c}(a.Connection||(a.Connection={}));a.Connection}(Talk||(Talk={}));var Talk;!function(a){!function(b){var c=function(b){function c(){b.apply(this,arguments)}return __extends(c,b),c.prototype.join=function(){},c.prototype.leave=function(){},c.prototype.get=function(b){if(b.key&&b.value&&b.peer){var c=this.group.get(b.peer);c||"offer"!==b.key||(c=this.group.add(b.peer),this.onAnswer(c)),c?c.parseMessage(b.key,b.value):a.warn("Peer not found!")}},c.prototype.remove=function(b){a.log("Removing a peer:",b);var c=this.group.get(b);return c?(c.close(),!0):!1},c}(b.Pure);b.Room=c}(a.Connection||(a.Connection={}));a.Connection}(Talk||(Talk={}));var Talk;!function(a){!function(a){!function(b){var c=function(a){function b(b,c){"undefined"==typeof c&&(c="http://localhost:8000"),a.call(this),this.group=b,this.group.on("message",this.send.bind(this)),this.server=io.connect(c),this.server.on("connect",this.connectionReady.bind(this)),this.server.on("message",this.get.bind(this))}return __extends(b,a),b.prototype.send=function(a){this.server.emit("message",a)},b}(a.Pure);b.Pure=c}(a.SocketIO||(a.SocketIO={}));a.SocketIO}(a.Connection||(a.Connection={}));a.Connection}(Talk||(Talk={}));var Talk;!function(a){!function(b){!function(c){var d=function(b){function c(c,d,e,f){"undefined"==typeof d&&(d="http://localhost:8000"),"undefined"==typeof e&&(e=a.noop);var g=this;b.call(this),this.group=c,this.group.on("message",this.send.bind(this)),this.server=io.connect(d),this.server.on("connect",function(){g.connectionReady(g.server.socket.sessionid)}),this.server.on("remove",this.remove.bind(this)),this.server.on("message",this.get.bind(this)),this.onAnswer=f?f:e,this.onOffer=e}return __extends(c,b),c.prototype.send=function(a){this.server.emit("message",a)},c.prototype.join=function(b,c,d){var e=this;this.server.emit("join",b,c,function(f,g){f?a.warn(f):(a.log("Joined to room `%s`",b),g.forEach(function(a){var b=e.group.add(a.id);e.onOffer(b),b.offer()}),e.room=b,e.type=c),a.safeCb(d)(f,g)})},c.prototype.leave=function(){a.log("Room `%s` was left",this.room),this.server.emit("leave"),this.group.find("close"),this.room=null,this.type=null},c}(b.Room);c.Room=d}(b.SocketIO||(b.SocketIO={}));b.SocketIO}(a.Connection||(a.Connection={}));a.Connection}(Talk||(Talk={}));var Talk;!function(a){var b=function(b){function c(c,d){b.call(this),this.groups=[],this.config={},this.peers=[],d||a.isStr(c)||(d=c,c=null),a.extend(this.config,d),this.id=c}return __extends(c,b),c.prototype.createGroup=function(b,d){var e=this;"undefined"==typeof d&&(d=c);var f=new d(b,this.config);return f.on("*",function(b,c){switch(b){case"message":c=a.clone(c),c.group=[f.id].concat(c.group),e.emit("message",c);break;default:e.emit.apply(e,arguments)}}),a.log("Group created:",f),this.groups.push(f),f},c.prototype.h=function(a,b){"undefined"==typeof b&&(b=c);var d=!1;return this.groups.some(function(b){return b.id===a?(d=b,!0):!1}),d||(d=this.createGroup(a,b)),d},c.prototype.add=function(b,c){var d=this;"undefined"==typeof c&&(c=a.Peer);var e=new c(b,this.config);return e.on("*",function(a){switch(a){case"closed":var b=d.peers.indexOf(e);b>=0&&d.peers.splice(b,1);default:d.emit.apply(d,arguments)}}),a.log("Peer added:",e),this.peers.push(e),e},c.prototype.get=function(a){var b=!1;return this.peers.some(function(c){return c.id===a?(b=c,!0):!1}),b},c.prototype.find=function(b,c){var d;switch(a.isObj(b)&&!a.isFunc(b)?d=this.peers.filter(function(c){return a.comp(b,c)}):(d=this.peers,c=b),typeof c){case"function":d.forEach(c);break;case"string":d.forEach(function(a){a[c]()})}return d},c}(WildEmitter);a.Group=b}(Talk||(Talk={}));var Talk;!function(a){function b(b){b.warn&&(a.warn=b.warn.bind(b)),b.log&&(a.log=b.log.bind(b))}function c(b,d,e){return"undefined"==typeof b&&(b=!0),"undefined"==typeof d&&(d=!0),a.userMedia&&!a.userMedia.ended?a.userMedia:(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,void navigator.getUserMedia({audio:b,video:d},function(b){a.log("User media request was successful"),a.userMedia=b,f(e)(null,b)},function(b){d&&b&&"DevicesNotFoundError"===b.name?c(!0,!1,f(e)):(a.warn(b),f(e)(b))}))}function d(b,c){return b.src=a.URL?a.URL.createObjectURL(c):c,b.autoplay=!0,b}function e(a){for(var b=a.split(";")[0].split(":")[1],c=atob(a.split(",")[1]),d=new Uint8Array(c.length),e=0;e<c.length;e++)d[e]=c.charCodeAt(e);return new Blob([d],{type:b})}function f(a){return"function"==typeof a?a:t}function g(a){return a.replace(/\s/g,"-").replace(/[^A-Za-z0-9_\-]/g,"").toString()}function h(a){return"function"==typeof a}function i(a){if(null===a||void 0===a)return!0;if(Array.isArray(a)||"string"==typeof a)return 0===a.length;for(var b in a)if(a.hasOwnProperty(b))return!1;return!0}function j(a){return"string"==typeof a}function k(a){return a===Object(a)}function l(a){return!isNaN(parseFloat(a))&&isFinite(a)}function m(a,b){return"undefined"==typeof a&&(a=0),"undefined"==typeof b&&(b=Math.pow(10,16)),Math.floor(Math.random()*(b-a+1)+a)}function n(a){"undefined"==typeof a&&(a=8);for(var b="";a>0;a--)b+=Math.floor(a/2)===a/2?"bcdfghjklmnpqrstvwxyz"[m(0,20)]:"aeiou"[m(0,4)];return b}function o(a){var b=Math.floor(a);return a>b?b+1:b}function p(){var a=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(b){var c=(a+16*Math.random())%16|0;return a=Math.floor(a/16),("x"===b?c:7&c|8).toString(16)})}function q(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}function r(a){return k(a)?Array.isArray(a)?a.slice(0):q({},a):a}function s(a,b){for(var c in a){if(!a.hasOwnProperty(c)||!b.hasOwnProperty(c))return!1;if(!(k(a[c])&&k(b[c])&&s(a[c],b[c]))&&a[c]!==b[c])return!1}return!0}function t(){for(var a=[],b=0;b<arguments.length-0;b++)a[b]=arguments[b+0]}a.PeerConnection=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection,a.SessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription,a.IceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate,a.MediaStream=window.MediaStream||window.webkitMediaStream,a.URL=window.URL||window.webkitURL,a.userMedia,a.warn=t,a.log=t,a.sctp=function(){var b=new a.PeerConnection({iceServers:[{url:"stun:stun.l.google.com:19302"}]},{});try{var c=b.createDataChannel("_test",{});return b.close(),c.reliable||!1}catch(d){return b.close(),!1}}(),a.negotiations=function(){var b=new a.PeerConnection({iceServers:[{url:"stun:stun.l.google.com:19302"}]},{optional:[{RtpDataChannels:!0}]});return b.onnegotiationneeded=function(){a.negotiations=!0},b.createDataChannel("_test"),setTimeout(function(){b.close()},1e3),!1}(),a.logger=b,a.getUserMedia=c,a.attachMediaStream=d,a.dataURLtoBlob=e,a.safeCb=f,a.safeStr=g,a.isFunc=h,a.isEmpty=i,a.isStr=j,a.isObj=k,a.isNum=l,a.randNum=m,a.randWord=n,a.roundUp=o,a.uuid=p,a.extend=q,a.clone=r,a.comp=s,a.noop=t}(Talk||(Talk={}));var Talk;!function(a){!function(a){!function(){!function(){function a(){}return a}()}(a.ArrayBuffer||(a.ArrayBuffer={}));a.ArrayBuffer}(a.Packet||(a.Packet={}));a.Packet}(Talk||(Talk={}));var Talk;!function(a){!function(b){!function(b){var c=function(c){function d(a){var b=this;c.call(this),this.threads=[],a.on("data",function(a,c,d){if(d.id&&d.key){var e=b.get(c,d.id);e||(e=b.add(a,c,d.id)),e.parse(d.key,d.value)}})}return __extends(d,c),d.prototype.send=function(a,b,c){var d=this.add(a,b);return d.chunk(c),d},d.prototype.add=function(c,d,e){var f=this,g=new b.Thread(d,e);return g.on("*",function(a,b){switch(a){case"message":c.sendData(d,b);break;case"sent":f.emit("sent",c,d,b);break;case"added":f.emit("added",c,d,b);break;case"data":f.emit("data",c,d,b);case"clean":f.clean(g)}}),a.log("New string packet handler thread was created `%s#%s`",d,g.id),this.threads.push(g),g},d.prototype.clean=function(b){a.log("Cleaning up string packet handler thread `%s#%s`",b.label,b.id);var c=this.threads.indexOf(b);return c>=0?(this.threads.splice(c,1),!0):!1},d.prototype.get=function(a,b){var c=!1;return this.threads.some(function(d){return d.label===a&&d.id===b?(c=d,!0):!1}),c},d}(WildEmitter);b.Handler=c}(b.String||(b.String={}));b.String}(a.Packet||(a.Packet={}));a.Packet}(Talk||(Talk={}));var Talk;!function(a){!function(b){!function(b){var c=function(b){function c(c,d){"undefined"==typeof d&&(d=a.uuid()),b.call(this),this.packets=[],this.sent=0,this.label=c,this.id=d}return __extends(c,b),c.prototype.parse=function(a,b){switch(a){case"add":this.add(b);break;case"end":this.join();break;case"ask":this.ask(b);break;case"clean":this.clean()}},c.prototype.send=function(a,b){this.emit("message",{value:b,id:this.id,key:a})},c.prototype.get=function(a){var b=!1;return this.packets.some(function(c){return c.index===a?(b=c,!0):!1}),b},c.prototype.sendPacket=function(a){var b=this;this.send("add",a),this.emit("sent",a),this.length<=++this.sent&&setTimeout(function(){b.send("end")},50)},c.prototype.chunk=function(b,c){var d=this;"undefined"==typeof c&&(c=10240),this.length=a.roundUp(b.length/c);var e=0,f=setInterval(function(){if(e<d.length){var a=c*e,g={payload:b.slice(a,a+c),length:d.length,index:e++};d.packets.push(g),d.sendPacket(g)}else clearInterval(f)},0)},c.prototype.join=function(){for(var b="",c=0;c<this.length;c++){var d=this.get(c);if(!d)return a.log("Requesting packet `%d` in thread `%s#%s`",c,this.label,this.id),void this.send("ask",c);b+=d.payload}a.log("Data received by `%s`:",this.id,b),this.emit("data",b),this.send("clean")},c.prototype.add=function(a){this.length||(this.length=a.length),this.packets.push(a),this.emit("added",a)},c.prototype.ask=function(b){var c=this.get(b);c&&(a.log("Resending packet `%d` in thread `%s#%s`",b,this.label,this.id),this.sendPacket(c))},c.prototype.clean=function(){this.emit("clean")},c}(WildEmitter);b.Thread=c}(b.String||(b.String={}));b.String}(a.Packet||(a.Packet={}));a.Packet}(Talk||(Talk={}));var Talk;!function(a){var b=function(b){function c(c,d){b.call(this),this.config={settings:{iceServers:[{url:"stun:stun.l.google.com:19302"},{url:"stun:stun1.l.google.com:19302"},{url:"stun:stun2.l.google.com:19302"},{url:"stun:stun3.l.google.com:19302"},{url:"stun:stun4.l.google.com:19302"}]},constraints:{optional:[{DtlsSrtpKeyAgreement:!0},{RtpDataChannels:!a.sctp}]},media:{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},serverDataChannel:!0,newLocalStream:!1,negotiate:!1},this.channels=[],this.packets={},a.extend(this.config,d),this.id=c,this.pc=new a.PeerConnection(this.config.settings,this.config.constraints),this.pc.oniceconnectionstatechange=this.onConnectionChange.bind(this),this.pc.onicechange=this.onConnectionChange.bind(this),this.pc.onnegotiationneeded=this.negotiate.bind(this),this.pc.onremovestream=this.onRemoveStream.bind(this),this.pc.ondatachannel=this.onDataChannel.bind(this),this.pc.onicecandidate=this.onCandidate.bind(this),this.pc.onaddstream=this.onAddStream.bind(this)}return __extends(c,b),c.prototype.sendMessage=function(a,b){var c={peer:this.id,value:b,group:[],key:a};this.emit("message",c)},c.prototype.parseMessage=function(a,b){switch(a){case"offer":this.answer(b);break;case"answer":this.handleAnswer(b);break;case"candidate":this.handleCandidate(b);break;case"data":this.handleData(null,b);break;default:return!1}return!0},c.prototype.onConnectionChange=function(){switch(a.log("Ice connection state was changed to `%s`",this.pc.iceConnectionState),this.pc.iceConnectionState){case"disconnected":case"failed":this.close();break;case"completed":case"closed":this.pc.onicecandidate=a.noop;break;default:this.pc.onicecandidate=this.onCandidate.bind(this)}this.emit("connectionState",this,this.pc.iceConnectionState)},c.prototype.onCandidate=function(b){b.candidate?(a.log("Candidate was found:",b.candidate),this.sendMessage("candidate",b.candidate)):a.log("End of candidates",b)},c.prototype.handleCandidate=function(b){a.isStr(b.candidate)&&a.isStr(b.sdpMid)&&a.isNum(b.sdpMLineIndex)?(a.log("Handling received candidate:",b),this.pc.addIceCandidate(new a.IceCandidate(b))):a.warn("Candidate could not be handled:",b)},c.prototype.negotiate=function(){a.log("Negotiation is needed"),this.config.negotiate&&("stable"===this.pc.signalingState?this.offer():a.warn("Signaling state is not stable"))},c.prototype.offer=function(){var b=this;a.log("Creating an offer"),this.pc.createOffer(function(c){b.pc.setLocalDescription(c,function(){b.sendMessage("offer",c),a.log("Offer created:",c)},function(b){a.warn(b)})},function(b){a.warn(b)},this.config.media)},c.prototype.answer=function(b){var c=this;a.log("Answering for an offer:",b),this.pc.setRemoteDescription(new a.SessionDescription(b),function(){c.pc.createAnswer(function(b){c.pc.setLocalDescription(b,function(){c.sendMessage("answer",b)},function(b){a.warn(b)})},function(b){a.warn(b)},c.config.media)},function(b){a.warn(b)})},c.prototype.handleAnswer=function(b){a.log("Handling an answer:",b),this.pc.setRemoteDescription(new a.SessionDescription(b),function(){a.log("Answer was handled successfully")},function(b){a.warn(b)})},c.prototype.close=function(){this.pc.close(),this.emit("closed",this),a.log("Peer closed:",this)},c.prototype.sendData=function(b,c){try{var d=this.getDataChannel(b);d.send(c.byteLength?c:JSON.stringify(c))}catch(e){this.config.serverDataChannel?this.sendMessage("data",c):a.warn(e)}},c.prototype.handleData=function(a,b){this.emit("data",this,a,b)},c.prototype.getDataChannel=function(a){var b=!1;return this.channels.some(function(c){return c.label===a?(b=c,!0):!1}),b},c.prototype.initDataChannel=function(b){var c=this;b.onclose=function(d){a.log("Channel named `%s` was closed",b.label),c.emit("channelClosed",c,d)},b.onerror=function(b){a.warn("Channel error:",b),c.emit("channelError",c,b)},b.onopen=function(d){a.log("Channel named `%s` was opened",b.label),c.emit("channelOpened",c,d)},b.onmessage=function(a){if(a.data){try{var d=JSON.parse(a.data)}catch(e){var d=a.data}c.handleData(b.label,d)}},b.binaryType="arraybuffer"},c.prototype.addDataChannel=function(b,c){var d=this.pc.createDataChannel(b,c);return this.initDataChannel(d),this.channels.push(d),a.log("Data channel was added:",d),a.negotiations||this.negotiate(),d},c.prototype.onDataChannel=function(b){b.channel?(this.initDataChannel(b.channel),this.channels.push(b.channel),a.log("Data channel was added:",b.channel)):a.warn("Data channel could not be added",b)},c.prototype.addStream=function(b){this.localStream=this.config.newLocalStream?new a.MediaStream(b):b,this.pc.addStream(this.localStream,this.config.media),a.log("Stream was added:",this.localStream),a.negotiations||this.negotiate()},c.prototype.onAddStream=function(b){b.stream?(a.log("Remote stream was added:",b.stream),this.remoteStream=b.stream,this.emit("streamAdded",this,this.remoteStream)):a.warn("Remote stream could not be added:",b)},c.prototype.onRemoveStream=function(b){this.remoteStream={},this.emit("streamRemoved",this),a.log("Remote stream was removed from peer:",b)},c.prototype.mute=function(){this.remoteStream.getAudioTracks().forEach(function(a){a.enabled=!1}),a.log("Peer audio was muted:",this)},c.prototype.unmute=function(){this.remoteStream.getAudioTracks().forEach(function(a){a.enabled=!0}),a.log("Peer audio was unmuted:",this)},c.prototype.pause=function(){this.remoteStream.getVideoTracks().forEach(function(a){a.enabled=!1}),a.log("Peer video was paused:",this)},c.prototype.resume=function(){this.remoteStream.getVideoTracks().forEach(function(a){a.enabled=!0}),a.log("Peer video was resumed:",this)},c.prototype.muteLocal=function(){this.localStream.getAudioTracks().forEach(function(a){a.enabled=!1}),a.log("Local audio for the peer was muted:",this)},c.prototype.unmuteLocal=function(){this.localStream.getAudioTracks().forEach(function(a){a.enabled=!0}),a.log("Local audio for the peer was unmuted:",this)},c.prototype.pauseLocal=function(){this.localStream.getVideoTracks().forEach(function(a){a.enabled=!1}),a.log("Local video for the peer was paused:",this)},c.prototype.resumeLocal=function(){this.localStream.getVideoTracks().forEach(function(a){a.enabled=!0}),a.log("Local video for the peer was resumed:",this)},c}(WildEmitter);a.Peer=b}(Talk||(Talk={}));