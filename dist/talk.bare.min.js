var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},Talk;!function(a){var b=function(a){function b(b,c){"undefined"==typeof c&&(c="http://localhost:8000");var d=this;a.call(this),this.warn=b.warn.bind(b),this.log=b.log.bind(b),this.handler=b,this.handler.on("message",this.send.bind(this)),this.server=io.connect(c),this.server.on("connect",function(){d.id=d.server.socket.sessionid,d.emit("connectionReady",d.id)}),this.server.on("message",this.get.bind(this))}return __extends(b,a),b.prototype.send=function(a){this.log("Sending:",a),this.server.emit("message",a)},b.prototype.get=function(a){if(this.log("Getting:",a),a.key&&a.value&&a.peer&&a.handler){var b=this.findHandler(a.handler).get(a.peer);b?(this.log("Peer found!"),b.parseMessage(a.key,a.value)):this.warn("Peer not found!")}},b.prototype.findHandler=function(a){var b=this.handler;return a.forEach(function(a){b=b.h(a)}),b},b}(WildEmitter);a.Connection=b}(Talk||(Talk={}));var Talk;!function(a){var b=function(b){function c(d,e){var f=this;b.call(this),this.config={media:{mandatory:{OfferToReceiveAudio:!1,OfferToReceiveVideo:!1}},logger:{warn:a.Util.noop,log:a.Util.noop},localStream:new a.Pointer,handler:c,supports:null,peer:a.Peer},this.handlers=[],this._peers=[],e||a.Util.isString(d)||(e=d,d=null),a.Util.extend(this.config,e),this.config.supports=this.config.supports||a.Util.supports(),this.warn=this.config.logger.warn.bind(this.config.logger),this.log=this.config.logger.log.bind(this.config.logger),this.id=d,this.config.localStream.on("change",function(a){f.localStream=a})}return __extends(c,b),c.prototype.getUserMedia=function(b,c){var d=this;return"undefined"==typeof b&&(b=!0),"undefined"==typeof c&&(c=!0),(!this.localStream||this.localStream.ended)&&a.Util.getUserMedia({audio:this.config.media.mandatory.OfferToReceiveAudio=b,video:this.config.media.mandatory.OfferToReceiveVideo=c},function(a){d.log("User media request was successful"),d.config.localStream.value=a,d.emit("localStream",a)},function(a){throw d.warn(a),Error(a)}),this.localStream},c.prototype.createHandler=function(b,c){var d=this;this.config.handler=c||this.config.handler;var e=new this.config.handler(b,this.config);return e.on("*",function(){for(var b=[],c=0;c<arguments.length-0;c++)b[c]=arguments[c+0];switch(b[0]){case"message":var f=b[1];f=a.Util.clone(f),f.handler=[e.id].concat(f.handler),d.emit("message",f);break;default:d.emit.apply(d,b)}}),this.log("Handler created:",e),this.handlers.push(e),e},c.prototype.h=function(a,b){var c=!1;return this.handlers.some(function(b){return b.id===a?(c=b,!0):!1}),c||(c=this.createHandler(a,b)),c},c.prototype.add=function(a){var b=this,c=new this.config.peer(a,this.config);return c.on("*",function(){for(var a=[],d=0;d<arguments.length-0;d++)a[d]=arguments[d+0];switch(a[0]){case"peerClosed":var e=b._peers.indexOf(c);e>=0&&b._peers.splice(e,1);default:b.emit.apply(b,a)}}),this.log("Peer added:",c),this._peers.push(c),c},c.prototype.get=function(a){var b=!1;return this._peers.some(function(c){return c.id===a?(b=c,!0):!1}),b},c.prototype.peers=function(b,c){var d;switch(a.Util.isObject(b)?d=this._peers.filter(function(c){return a.Util.comp(b,c)}):(d=this._peers,c=b),typeof c){case"function":d.forEach(c);break;case"string":d.forEach(function(a){a[c]()})}return d},c}(WildEmitter);a.Handler=b}(Talk||(Talk={}));var Talk;!function(a){var b=function(b){function c(c,d){b.call(this),this.config={options:{iceServers:[{url:"stun:stun.l.google.com:19302"},{url:"stun:stun1.l.google.com:19302"},{url:"stun:stun2.l.google.com:19302"},{url:"stun:stun3.l.google.com:19302"},{url:"stun:stun4.l.google.com:19302"}]},media:{mandatory:{OfferToReceiveAudio:!1,OfferToReceiveVideo:!1}},logger:{warn:a.Util.noop,log:a.Util.noop},supports:null,negotiate:!1},this.channels=[],a.Util.overwrite(this.config,d),this.warn=this.config.logger.warn.bind(this.config.logger),this.log=this.config.logger.log.bind(this.config.logger),this.supports=this.config.supports||a.Util.supports(),this.id=c,this.pc=new a.Util.PeerConnection(this.config.options,{optional:[{RtpDataChannels:!this.supports.sctp},{DtlsSrtpKeyAgreement:!0}]}),this.pc.oniceconnectionstatechange=this.onConnectionChange.bind(this),this.pc.onicechange=this.onConnectionChange.bind(this),this.pc.onnegotiationneeded=this.negotiate.bind(this),this.pc.onremovestream=this.onRemoveStream.bind(this),this.pc.ondatachannel=this.onDataChannel.bind(this),this.pc.onicecandidate=this.onCandidate.bind(this),this.pc.onaddstream=this.onAddStream.bind(this)}return __extends(c,b),c.prototype.sendMessage=function(a,b){var c={peer:this.id,value:b,handler:[],key:a};this.emit("message",c)},c.prototype.parseMessage=function(a,b){switch(this.log("Parsing:",a,b),a){case"offer":this.answer(b);break;case"answer":this.handleAnswer(b);break;case"candidate":this.handleCandidate(b);break;default:return!1}return!0},c.prototype.addStream=function(b){this.localStream=new a.Util.MediaStream(b),this.pc.addStream(this.localStream,this.config.media),this.log("Stream was added:",this.localStream),this.supports.negotiation||this.negotiate()},c.prototype.onAddStream=function(a){a.stream?(this.log("Remote stream was added:",a.stream),this.remoteStream=a.stream,this.emit("streamAdded",this)):this.warn("Remote stream could not be added:",a)},c.prototype.onRemoveStream=function(a){this.remoteStream={},this.emit("streamRemoved",this),this.log("Remote stream was removed from peer:",a)},c.prototype.send=function(a,b){var c=this.getDataChannel(a);return c&&"open"===c.readyState?(c.send(JSON.stringify(b)),!0):(this.warn("Data channel named `%s` does not exists or it is not opened",a),!1)},c.prototype.getDataChannel=function(a){var b=!1;return this.channels.some(function(c){return c.label===a?(b=c,!0):!1}),b},c.prototype.configDataChannel=function(a){var b=this;a.onclose=function(c){b.log("Channel named `%s` was closed",a.label),b.emit("channelClosed",b,c)},a.onerror=function(a){b.warn("Channel error:",a),b.emit("channelError",b,a)},a.onopen=function(c){b.log("Channel named `%s` was opened",a.label),b.emit("channelOpened",b,c)},a.onmessage=function(c){if(c.data){var d=JSON.parse(c.data);b.log("Getting (%s):",a.label,d),b.emit("channelMessage",b,d)}}},c.prototype.addDataChannel=function(a,b){var c=this.pc.createDataChannel(a,b);return this.configDataChannel(c),this.channels.push(c),this.log("Data channel was added:",c),this.supports.negotiation||this.negotiate(),c},c.prototype.onDataChannel=function(a){a.channel?(this.configDataChannel(a.channel),this.channels.push(a.channel),this.log("Data channel was added:",a.channel)):this.warn("Data channel could not be added",a)},c.prototype.onConnectionChange=function(){switch(this.log("Ice connection state was changed to `%s`",this.pc.iceConnectionState),this.pc.iceConnectionState){case"disconnected":case"failed":this.close();break;case"completed":case"closed":this.pc.onicecandidate=a.Util.noop;break;default:this.pc.onicecandidate=this.onCandidate.bind(this)}},c.prototype.onCandidate=function(b){b.candidate?(this.log("Candidate was found:",b.candidate),this.sendMessage("candidate",b.candidate),this.pc.onicecandidate=a.Util.noop):this.log("End of candidates",b)},c.prototype.handleCandidate=function(b){b.candidate&&b.sdpMid&&a.Util.isNumber(b.sdpMLineIndex)?(this.log("Handling received candidate:",b),this.pc.addIceCandidate(new a.Util.IceCandidate(b))):this.warn("Candidate could not be handled:",b)},c.prototype.negotiate=function(){this.log("Negotiation is needed"),this.config.negotiate&&("stable"===this.pc.signalingState?this.offer():this.warn("Signaling state is not stable"))},c.prototype.offer=function(){var a=this;this.log("Creating an offer"),this.pc.createOffer(function(b){a.pc.setLocalDescription(b,function(){a.sendMessage("offer",b),a.log("Offer created:",b)},function(b){a.warn(b)})},function(b){a.warn(b)},this.config.media)},c.prototype.answer=function(b){var c=this;this.log("Answering for an offer:",b),this.pc.setRemoteDescription(new a.Util.SessionDescription(b),function(){c.pc.createAnswer(function(a){c.pc.setLocalDescription(a,function(){c.sendMessage("answer",a)},function(a){c.warn(a)})},function(a){c.warn(a)},c.config.media)},function(a){c.warn(a)})},c.prototype.handleAnswer=function(b){var c=this;this.log("Handling an answer:",b),this.pc.setRemoteDescription(new a.Util.SessionDescription(b),function(){c.log("Answer was handled successfully")},function(a){c.warn(a)})},c.prototype.close=function(){this.pc.close(),this.emit("peerClosed",this),this.log("Peer closed:",this)},c.prototype.mute=function(){this.remoteStream.getAudioTracks().forEach(function(a){a.enabled=!1}),this.log("Peer audio was muted:",this)},c.prototype.unmute=function(){this.remoteStream.getAudioTracks().forEach(function(a){a.enabled=!0}),this.log("Peer audio was unmuted:",this)},c.prototype.pause=function(){this.remoteStream.getVideoTracks().forEach(function(a){a.enabled=!1}),this.log("Peer video was paused:",this)},c.prototype.resume=function(){this.remoteStream.getVideoTracks().forEach(function(a){a.enabled=!0}),this.log("Peer video was resumed:",this)},c.prototype.muteLocal=function(){this.localStream.getAudioTracks().forEach(function(a){a.enabled=!1}),this.log("Local audio for the peer was muted:",this)},c.prototype.unmuteLocal=function(){this.localStream.getAudioTracks().forEach(function(a){a.enabled=!0}),this.log("Local audio for the peer was unmuted:",this)},c.prototype.pauseLocal=function(){this.localStream.getVideoTracks().forEach(function(a){a.enabled=!1}),this.log("Local video for the peer was paused:",this)},c.prototype.resumeLocal=function(){this.localStream.getVideoTracks().forEach(function(a){a.enabled=!0}),this.log("Local video for the peer was resumed:",this)},c}(WildEmitter);a.Peer=b}(Talk||(Talk={}));var Talk;!function(a){var b=function(a){function b(b){a.call(this),this.memory={value:null},this.memory.value=b||null}return __extends(b,a),Object.defineProperty(b.prototype,"value",{get:function(){return this.memory.value},set:function(a){this.memory.value=a,this.emit("change",a)},enumerable:!0,configurable:!0}),b}(WildEmitter);a.Pointer=b}(Talk||(Talk={}));var Talk;!function(a){var b=function(b){function c(c,d,e,f){"undefined"==typeof d&&(d="http://localhost:8000"),"undefined"==typeof e&&(e=a.Util.noop),b.call(this,c,d),this.onAnswer=f?f:e,this.onOffer=e,this.server.on("remove",this.remove.bind(this))}return __extends(c,b),c.prototype.get=function(a){if(this.log("Getting:",a),a.key&&a.value&&a.peer){var b=this.handler.get(a.peer);b||"offer"!==a.key||(b=this.handler.add(a.peer),this.onAnswer(b)),b?(this.log("Peer found!"),b.parseMessage(a.key,a.value)):this.warn("Peer not found!")}},c.prototype.join=function(b,c,d){var e=this;this.server.emit("join",b,c,function(f,g){e.log("Joined to room `%s`",b),f&&e.warn(f),g.forEach(function(a){var b=e.handler.add(a.id);e.onOffer(b),b.offer()}),e.room=b,e.type=c,a.Util.safeCb(d)(f,g)})},c.prototype.leave=function(){this.log("Room `%s` was left",this.room),this.server.emit("leave"),this.handler.peers("close"),this.room=null,this.type=null},c.prototype.remove=function(a){this.log("Removing a peer:",a);var b=this.handler.get(a);return b?(b.close(),!0):!1},c}(a.Connection);a.Room=b}(Talk||(Talk={}));var Talk;!function(a){var b=function(){function a(){}return a.getUserMedia=function(){for(var a=[],b=0;b<arguments.length-0;b++)a[b]=arguments[b+0];(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia).apply(navigator,a)},a.attachMediaStream=function(a,b){return a.src=window.URL?window.URL.createObjectURL(b):b,a.autoplay=!0,a},a.safeCb=function(a){return"function"==typeof a?a:this.noop},a.safeStr=function(a){return a.replace(/\s/g,"-").replace(/[^A-Za-z0-9_\-]/g,"").toString()},a.safeText=function(a){return a.replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},a.isEmpty=function(a){if(null===a||void 0===a)return!0;if(Array.isArray(a)||"string"==typeof a)return 0===a.length;for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},a.isString=function(a){return"string"==typeof a&&!this.isEmpty(a)},a.isObject=function(a){return a===Object(a)},a.isNumber=function(a){return!isNaN(parseFloat(a))&&isFinite(a)},a.randNum=function(a,b){return"undefined"==typeof a&&(a=0),"undefined"==typeof b&&(b=Math.pow(10,16)),Math.floor(Math.random()*(b-a+1)+a)},a.randWord=function(a){"undefined"==typeof a&&(a=8);for(var b="";a>0;a--)b+=Math.floor(a/2)===a/2?"bcdfghjklmnpqrstvwxyz"[this.randNum(0,20)]:"aeiou"[this.randNum(0,4)];return b},a.sha256=function(a){return CryptoJS.SHA256(a).toString()},a.find=function(a,b){return a.indexOf(b)>=0},a.extend=function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a},a.overwrite=function(a,b){for(var c in a)a.hasOwnProperty(c)&&b.hasOwnProperty(c)&&(a[c]=b[c]);return a||{}},a.clone=function(a){return this.isObject(a)?Array.isArray(a)?a.slice(0):this.extend({},a):a},a.comp=function(a,b){for(var c in a)if(!(this.isObject(a[c])&&this.isObject(b[c])&&this.comp(a[c],b[c]))&&a[c]!==b[c])return!1;return!0},a.supports=function(a){if(!this.PeerConnection)return{};var b,c,d=!!window.webkitRTCPeerConnection,e=!0,f=!1,g=!1,h=!0;a=a||{iceServers:[{url:"stun:stun.l.google.com:19302"}]};try{b=new this.PeerConnection(a,{optional:[{RtpDataChannels:!0}]})}catch(i){h=!1,e=!1}if(h)try{c=b.createDataChannel("_test")}catch(i){h=!1}if(h){try{c.binaryType="blob",f=!0}catch(i){}var j=new this.PeerConnection(a,{});try{var k=j.createDataChannel("_reliableTest",{});g=k.reliable}catch(i){}j.close()}if(e&&(e=!!b.addStream),!d&&h){var l=new this.PeerConnection(a,{optional:[{RtpDataChannels:!0}]});l.onnegotiationneeded=function(){d=!0},l.createDataChannel("_negotiationTest"),setTimeout(function(){l.close()},1e3)}return b&&b.close(),{negotiation:d,media:e,blob:f,sctp:g,data:h}},a.noop=function(){for(var a=[],b=0;b<arguments.length-0;b++)a[b]=arguments[b+0]},a.PeerConnection=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection,a.SessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription,a.IceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate,a.MediaStream=window.MediaStream||window.webkitMediaStream,a}();a.Util=b}(Talk||(Talk={}));